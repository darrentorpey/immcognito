<html><head>
  <script type="text/javascript" src="akihabara/akihabara/gbox.js"></script>
  <script type="text/javascript" src="akihabara/akihabara/iphopad.js"></script>
  <script type="text/javascript" src="akihabara/akihabara/trigo.js"></script>
  <script type="text/javascript" src="akihabara/akihabara/toys.js"></script>
  <script type="text/javascript" src="akihabara/akihabara/help.js"></script>
  <script type="text/javascript" src="akihabara/akihabara/tool.js"></script>
  <script type="text/javascript" src="akihabara/akihabara/gamecycle.js"></script>

  <script type="text/javascript" src="map/map.js"></script>
  <script type="text/javascript" src="screens/screens.js"></script>
  <script type="text/javascript" src="actors/player.js"></script>
  <script type="text/javascript" src="actors/enemies.js"></script>
  <script type="text/javascript" src="extras.js"></script>

  <style>BODY { -webkit-user-select: none; margin: 0px }</style>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
  <script>

window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){console.log(Array.prototype.slice.call(arguments))}};

var maingame;
var map;
var player;
var frameCount = 0;  // This keeps track of how many frames have been rendered in total
var timeStarted;     // This will record the current time when the game started

var TILE_WIDTH = 8;

window.addEventListener('load', function () {
  help.akihabaraInit({
    title:  '8by5',
    width:  640,
    height: 480,
    zoom:   1
  });

  gbox.addBundle({ file: 'resources/bundle.js' });

  gbox.loadAll(loadGame);
}, false);

function loadGame() {
  gbox.setGroups(['background', 'bullets', 'workplaces', 'player', 'enemy', 'game']);

  maingame = gamecycle.createMaingame('game', 'game');

  maingame.gameMenu = function() { return true; };
  maingame.gameIntroAnimation = function() { return true; };
  maingame.gameTitleIntroAnimation = introScreenAnimation;
  maingame.initializeGame = function() {
    addActors();

    // This gives us the time at which the game started,
    //  in milliseconds since the epoch
    timeStarted = (new Date()).getTime();

    // This adds a "label" widget, with "small"-font text to the screen
    //  located 25 pixels down from the top of the screen and
    //  40 pixels back from the right side of the screen
    maingame.hud.setWidget('time_survived', {
      widget: 'label',
      font:   'small',
      value:  0,
      dx:     gbox.getScreenW() - 40,
      dy:     25,
      clear:  true
    });
  };

  // Here we setup our map. See part 3 for a detailed explanation
  map = help.finalizeTilemap({
    tileset: 'map_pieces', // Specify that we're using the 'map_pieces' tiles that we created in the loadResources function
    map: loadMap(),
    tileIsSolid: function(obj, t) {
      return t != null; // Is a wall if is not an empty space
    }
  });

  extendMap(map);

  gbox.createCanvas('map_canvas', { w: map.w, h: map.h });
  gbox.blitTilemap(gbox.getCanvasContext('map_canvas'), map);
  gbox.go();
}

function addActors() {
  // Create the 'player' (see tutorial Part 2 for a detailed explanation)
  player = addPlayer();

  // Create the 'map' (see tutorial Part 3 for a detailed explanation)
  addMap();

  // Workplaces
  addWorkplaces();
  
  addEnemies();
}

function addWorkplaces() {
  gbox.addObject({
    id:      'cow_1',    // id refers to the specific object.
    group:   'workplaces',       // The rendering group
    tileset: 'cow', // tileset is where the graphics come from.
    colh:    gbox.getTiles('cow').tileh,

    initialize: function() {
      toys.topview.initialize(this, {});
      this.x = TILE_WIDTH * 12;
      this.y = TILE_WIDTH * 8;
    },

    blit: function() {
      gbox.blitTile(gbox.getBufferContext(), {
        tileset: this.tileset,
        tile:    this.frame,
        dx:      this.x,
        dy:      this.y,
        fliph:   this.fliph,
        flipv:   this.flipv,
        camera:  this.camera,
        alpha:   1.0
      });
    },
  });
}
</script>
</head><body></body></html>
